name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release-typescript:
    name: Release TypeScript SDK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '24.x'
          registry-url: 'https://registry.npmjs.org'
      - name: Build + Publish
        working-directory: TypeScript
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          npm ci
          npm version "${VERSION}" --no-git-tag-version
          npm run build
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_API_KEY }}

  release-python:
    name: Release Python SDK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'
      - name: Build + Publish
        working-directory: Python
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          export VERSION

          python -m pip install --upgrade pip
          python -m pip install build twine

          python -c 'import os, pathlib, re; version=os.environ["VERSION"]; p=pathlib.Path("pyproject.toml"); s=p.read_text(encoding="utf-8"); s2=re.sub(r"(?m)^version\\s*=\\s*\\\"[^\\\"]+\\\"\\s*$", f"version = \\\"{version}\\\"", s, count=1); (s2!=s) or (_ for _ in ()).throw(SystemExit("Failed to update version in pyproject.toml")); p.write_text(s2, encoding="utf-8")'

          python -m build
          python -m twine upload --skip-existing dist/*
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_KEY }}

  release-rust:
    name: Release Rust SDK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: '1.93.0'
      - name: Publish
        working-directory: Rust
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          sed -i "0,/^version = \".*\"/s//version = \"${VERSION}\"/" Cargo.toml
          cargo publish --token "${CRATES_API_KEY}" --allow-dirty
        env:
          CRATES_API_KEY: ${{ secrets.CRATES_API_KEY }}

  release-ruby:
    name: Release Ruby SDK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '4.0.1'
      - name: Build + Publish
        working-directory: Ruby
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          sed -i "s/VERSION = \\\"[^\"]\\+\\\"/VERSION = \\\"${VERSION}\\\"/" lib/noie_nds_api/version.rb

          mkdir -p "${HOME}/.gem"
          printf -- "---\n:rubygems_api_key: %s\n" "${RUBY_API_KEY}" > "${HOME}/.gem/credentials"
          chmod 0600 "${HOME}/.gem/credentials"

          gem build noie-nds-api.gemspec
          gem push noie-nds-api-*.gem
        env:
          RUBY_API_KEY: ${{ secrets.RUBY_API_KEY }}

  release-java:
    name: Release Java SDK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
      
      - name: Build
        run: |
          chmod +x gradlew
          ./gradlew :java:build

      # --------------------------------------------------------------------
      # Publish to Maven Central (Sonatype Central Portal - Publisher API)
      # Docs:
      # - Bundle format: https://central.sonatype.org/publish/publish-portal-upload/
      # - Publisher API: https://central.sonatype.org/publish/publish-portal-api
      # --------------------------------------------------------------------
      - name: Publish to Maven Central (Central Portal)
        shell: bash
        run: |
          set -euo pipefail

          chmod +x gradlew

          VERSION="${GITHUB_REF_NAME#v}"
          GROUP_ID="io.github.misty4119"
          ARTIFACT_ID="noiedigitalsystem-api"

          # 1) Publish signed artifacts to Maven Local (~/.m2)
          ./gradlew :java:publishMavenPublicationToMavenLocal -PenableSigning=true -PreleaseVersion="${VERSION}"

          # 2) Assemble Central Portal bundle (Maven Repository Layout)
          GROUP_PATH="${GROUP_ID//./\/}"
          SRC_DIR="${HOME}/.m2/repository/${GROUP_PATH}/${ARTIFACT_ID}/${VERSION}"
          BUNDLE_ROOT="${PWD}/central-bundle"
          DEST_DIR="${BUNDLE_ROOT}/${GROUP_PATH}/${ARTIFACT_ID}/${VERSION}"

          if [[ ! -d "${SRC_DIR}" ]]; then
            echo "Expected Maven Local directory not found: ${SRC_DIR}"
            exit 1
          fi

          rm -rf "${BUNDLE_ROOT}"
          mkdir -p "${DEST_DIR}"
          cp -R "${SRC_DIR}/." "${DEST_DIR}/"

          # 3) Generate checksums required by Central Portal (.md5, .sha1)
          pushd "${BUNDLE_ROOT}" >/dev/null
          while IFS= read -r -d '' f; do
            md5sum "${f}" | awk '{print $1}' > "${f}.md5"
            sha1sum "${f}" | awk '{print $1}' > "${f}.sha1"
          done < <(find . -type f ! -name '*.md5' ! -name '*.sha1' -print0)
          popd >/dev/null

          # Zip from inside the directory so paths start with io/github/... not central-bundle/io/...
          pushd "${BUNDLE_ROOT}" >/dev/null
          zip -r ../central-bundle.zip .
          popd >/dev/null

          # 4) Upload bundle via Central Portal Publisher API (AUTOMATIC publish)
          AUTH="$(printf "%s:%s" "${MAVEN_CENTRAL_USERNAME}" "${MAVEN_CENTRAL_PASSWORD}" | base64 -w0)"
          DEPLOYMENT_ID="$(curl -sS -X POST \
            -H "Authorization: Bearer ${AUTH}" \
            -F "bundle=@central-bundle.zip" \
            "https://central.sonatype.com/api/v1/publisher/upload?name=${GROUP_ID}:${ARTIFACT_ID}:${VERSION}&publishingType=AUTOMATIC")"

          echo "Central deployment id: ${DEPLOYMENT_ID}"

          # 5) Poll status until published (or failed)
          # Note: Central Portal publishing can take a while. We treat prolonged
          # PUBLISHING as non-fatal and rely on the Portal UI as source of truth.
          for i in $(seq 1 180); do
            STATUS="$(curl -sS -X POST \
              -H "Authorization: Bearer ${AUTH}" \
              "https://central.sonatype.com/api/v1/publisher/status?id=${DEPLOYMENT_ID}")"
            echo "${STATUS}"

            if echo "${STATUS}" | grep -q '"deploymentState":"PUBLISHED"'; then
              echo "Published to Maven Central."
              exit 0
            fi
            if echo "${STATUS}" | grep -q '"deploymentState":"FAILED"'; then
              echo "Central publish FAILED."
              exit 1
            fi
            sleep 10
          done

          echo "Timed out waiting for Central publish (still processing)."
          echo "Check deployment status in Central Portal:"
          echo "  https://central.sonatype.com/publishing/deployments"
          exit 0
        env:
          # Central Portal token (username/password) â€” used for Publisher API auth
          MAVEN_CENTRAL_USERNAME: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          MAVEN_CENTRAL_PASSWORD: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}

          # Pass secrets to Gradle as project properties (avoid committing secrets)
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingKey: ${{ secrets.SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingPassword: ${{ secrets.SIGNING_PASSWORD }}

  release-csharp:
    name: Release C# SDK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      
      - name: Build and Pack
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          dotnet pack csharp/ --configuration Release -o artifacts -p:Version="${VERSION}"
      
      - name: Publish to NuGet
        shell: bash
        run: |
          set -euo pipefail
          # Only push .nupkg (symbols are embedded via DebugType=embedded)
          dotnet nuget push "artifacts/*.nupkg" --source "https://api.nuget.org/v3/index.json" --api-key "${NUGET_API_KEY}" --skip-duplicate
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

  create-release:
    name: Create GitHub Release
    needs: [release-java, release-csharp, release-typescript, release-python, release-rust, release-ruby]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
